<!DOCTYPE html>
<html>
<head>
  <title>Salesforce Canvas - Google API Test 2.0</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <!-- Always load Canvas SDK relative to Salesforce org -->
  <script src="/canvas/sdk/js/36.0/canvas-all.js"></script>
  <script src="/canvas/sdk/js/56.0/canvas-all.js"></script>

</head>
<body>
  <h2>Salesforce Canvas - Google API Test 1.0</h2>
  <div id="output">Loading...</div>

  <script>
    // Called when Canvas is ready
    Sfdc.canvas(function () {
      console.log("Canvas initialized...");
      Sfdc.canvas.oauth.init();

      // Fetch signed request from Salesforce
      Sfdc.canvas.client.refreshSignedRequest(function (data) {
        console.log("Signed Request Data:", data);

        if (!data) {
          $("#output").html("<p>❌ No signed request received. Check Canvas App Settings.</p>");
          return;
        }

        if (data.context && data.context.user) {
          $("#output").html("<p>Connected to Salesforce as: <b>" +
            data.context.user.fullName + "</b></p>");
        } else {
          $("#output").html("<p>❌ Failed to load signed request.</p>");
          return;
        }

        // If signed request worked → call Apex REST wrapper
        fetchGoogleUser();
      });
    });

    // Call Apex REST Wrapper (GoogleAPIService class)
    function fetchGoogleUser() {
      $.ajax({
        url: "/services/apexrest/GoogleAPI/userinfo",
        method: "GET",
        success: function (res) {
          console.log("Google API Response:", res);
          $("#output").append("<p>✅ Google User Info: " + JSON.stringify(res) + "</p>");
        },
        error: function (err) {
          console.error("Google API Error:", err);
          $("#output").append("<p>❌ Google API Error: " + JSON.stringify(err) + "</p>");
        }
      });
    }
  </script>
</body>
</html>

